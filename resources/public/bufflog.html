<html>
<head>
  <style type="text/css">
  .space {
    font-family: monospace;
    height: 100%;
    float: left;
  }
  .editable {
    background: #eee;
  }
  #input {
    width: 15%;
    margin-left: 125px;
  }
  #processed {
    width: 40%;
  }
  #analysis {
    width: 30%;
  }
  .red {
    color: red;
  }
  #input div:before {
    display: inline-block;
    content: attr(class);
    border-radius: 2px;
    color: blue;
    width: 125px;
    margin-left: -130px;
    text-align: right;
    padding-right: 5px;
  }


  </style>
  <!--<script type="text/javascript" src="js/main.js"></script>-->
  <!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>-->
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <script type="text/javascript" src="js/jquery.sparkline.min.js"></script>
  <script type="text/javascript">
    /*
    TODO:
      save contents + reload using localstorage
    BUGS:
      possible to delete everything if backspace at top


    */


    /*
      year
        month
          day
            activity
              food|exercise





    */
    $(function(){

      // helper functions

      var delay = (function(){
        var timer = 0;
        return function(callback, ms){
          clearTimeout (timer);
          timer = setTimeout(callback, ms);
        };
      })();

      var getType = function(a){
        if(typeof(a) == "object")
          return Object.keys(a)[0]
      };

    

      $('#input').bind({
        // on keyup, re-scan current line
        // BUG: if move cursor down/up, skips analysis of previous lines
        //     need to mark lines as "edited" to rescan
        keyup: function(){
          selection = window.getSelection()
          activeLineDiv = selection.baseNode.nodeName == "#text" ? selection.baseNode.parentNode : selection.baseNode
          
          processLine(activeLineDiv);

          delay(function(){
            // some other processing to be delayed
          }, 500);
        },
        // on paste, re-scan entire text
        paste: function(){
          $("#input").html("<div></div>"); // prevents nested divs
          setTimeout(function(){
            $("#input div").each(function(){
              processLine(this);
            });
          }, 0)
        }
      });

      // on paste, re-scan entire input
      var rescan = function() {
        $('#processed').html("")
        //...

        $("#input div").each(function(){
          for(var regex in regex_matches){
            if(m = $(this).text().match(RegExp(regex,"i"))){
              $("#processed").append((regex_matches[regex])(m))
              break;
            } 
          }
          $("#processed").append("<br />")
        });
      }




      var processLine = function(activeDivLine){
        $(activeDivLine).attr("class", getType(lineToData($(activeDivLine).text())) || "")
      }

      var lineToData = function(inputText) {
        
        // categorize

        newYear = function(a){
          return { year: a }
        }
        newMonth = function(a){
          return { month: a[0] }
        }
        newActivity = function(a){
          return { activity: a }
        }
        newDay = function(a){
          return { day: a }
        }
        newFood = function(a){
          return { food: 
            {
              name: a[3],
              mass: { quantity: a[1], unit: a[2] }
            }
          }
        }
        newExercise = function(a){
          return { exercise: 
            {
              name: a[4],
              mass: { quantity: a[1], unit: "lbs" },
              reps: a[2],
              sets: a[3]
            }
          }
        }
        newBodyMass = function(a){
          return { bodyMass: { mass: { quantity: a[1], unit: a[2] } } }
        }

        regex_matches = {
          "^[0-9]{4}$": newYear
          ,"^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-zA-Z]+$": newMonth
          ,"^[a-zA-Z]+$": newActivity
          ,"^[0-9]{2}$": newDay
          ,"^([0-9\.]+)([a-zA-Z]*) ([a-zA-Z -]+)$": newFood
          ,"^([0-9]+)x([0-9]+)x([0-9]) ([a-zA-Z]+)$": newExercise
          ,"^([0-9]+)(lb|kg)": newBodyMass
        }

        for(var regex in regex_matches){
          if(m = inputText.match(RegExp(regex,"i"))){
            return (regex_matches[regex])(m)
          } 
        }
        
      }

      

      // analysis

      analysis = "10/08/12 100g\n10/08/12 100g"

      $("#analysis").append(analysis)


      // sparklines

      //http://omnipotent.net/jquery.sparkline/#s-docs

      charts = ["weight","food","calories","carbs","derps","squat","press","bench","dead"]

      for(chart in charts){
        $("#charts").append(charts[chart])
        spark = $("<span></span>")
        $("#charts").append(spark)
        spark.sparkline([Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random()],{type: 'bar'})
        $("#charts").append(Math.floor(100*Math.random())+"<br/>")

      }

    });
  </script>
</head>
<body>
<div id="input" class="space editable" contentEditable="true"><div><br/></div></div>
<div id="processed" class="space" ></div>
<div id="analysis" class="space" ></div>
<div id="charts" class="space" ></div>
</body>
</html>